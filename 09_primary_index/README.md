# Первичный разряженный индекс в Clickhouse

### 1. Создаем таблицу без индекса

```sql
DROP TABLE learn_db.mart_student_lesson;
CREATE TABLE learn_db.mart_student_lesson
(
	`student_profile_id` Int32, -- Идентификатор профиля обучающегося
	`person_id` String, -- GUID обучающегося
	`person_id_int` Int32 CODEC(Delta, ZSTD),
	`educational_organization_id` Int16, -- Идентификатор образовательной организации
	`parallel_id` Int16,
	`class_id` Int16, -- Идентификатор класса
	`lesson_date` Date32, -- Дата урока
	`lesson_month_digits` String,
	`lesson_month_text` String,
	`lesson_year` UInt16,
	`load_date` Date, -- Дата загрузки данных
	`t` Int16 CODEC(Delta, ZSTD),
	`teacher_id` Int32 CODEC(Delta, ZSTD), -- Идентификатор учителя
	`subject_id` Int16 CODEC(Delta, ZSTD), -- Идентификатор предмета
	`subject_name` String,
	`mark` Int8, -- Оценка
	PRIMARY KEY tuple()
) ENGINE = MergeTree()
PARTITION BY (educational_organization_id)
AS SELECT
	floor(randUniform(2, 1300000)) as student_profile_id,
	cast(student_profile_id as String) as person_id,
	cast(person_id as Int32) as  person_id_int,
    student_profile_id / 365000 as educational_organization_id,
    student_profile_id / 73000 as parallel_id,
    student_profile_id / 2000 as class_id,
    cast(now() - randUniform(2, 60*60*24*365) as date) as lesson_date, -- Дата урока
    formatDateTime(lesson_date, '%Y-%m') as lesson_month_digits,
    formatDateTime(lesson_date, '%Y %M') AS lesson_month_text,
    toYear(lesson_date) as lesson_year, 
    lesson_date + rand() % 3, -- Дата загрузки данных
    floor(randUniform(2, 137)) as t,
    educational_organization_id * 136 + t as teacher_id,
    floor(t/9) as subject_id,
    CASE subject_id
    	WHEN 1 THEN 'Математика'
    	WHEN 2 THEN 'Русский язык'
    	WHEN 3 THEN 'Литература'
    	WHEN 4 THEN 'Физика'
    	WHEN 5 THEN 'Химия'
    	WHEN 6 THEN 'География'
    	WHEN 7 THEN 'Биология'
    	WHEN 8 THEN 'Физическая культура'
    	ELSE 'Информатика'
    END as subject_name,
    CASE 
    	WHEN randUniform(0, 2) > 1
    		THEN -1
    		ELSE 
    			CASE
	    			WHEN ROUND(randUniform(0, 5)) + subject_id < 5 THEN ROUND(randUniform(4, 5))
	    			WHEN ROUND(randUniform(0, 5)) + subject_id < 9 THEN ROUND(randUniform(3, 5))
	    			ELSE ROUND(randUniform(2, 5))
    			END				
    END AS mark
FROM numbers(10000000);
```

### 2. Выполняем запрос в clickhouse-client

```sql
SELECT 
	avg(mark) as avg_m,
	teacher_id
FROM 
	learn_db.mart_student_lesson
WHERE 
	lesson_date = subtractDays(today(), 10)
GROUP BY
	teacher_id
ORDER BY avg_m desc
LIMIT 10;
```

Результат
```text

Query id: 6ce9915b-0468-4ecc-b2ad-c37aecae9368

    ┌──────────────avg_m─┬─teacher_id─┐
 1. │                  5 │          4 │
 2. │                  5 │          3 │
 3. │                  5 │         10 │
 4. │                  4 │        618 │
 5. │                  4 │          2 │
 6. │                  4 │        620 │
 7. │ 3.8333333333333335 │         30 │
 8. │                3.8 │         24 │
 9. │ 3.1052631578947367 │         61 │
10. │ 3.0833333333333335 │         14 │
    └────────────────────┴────────────┘

10 rows in set. Elapsed: 0.059 sec. Processed 10.00 million rows, 90.00 MB (168.13 million rows/s., 1.51 GB/s.)
Peak memory usage: 186.69 KiB.
```

Абсолютно все строки были прочитаны с диска для выполнения запроса. 

### 3. Создаем вторую таблицу с первичным индексом по lesson_date и теми же данными

```sql
DROP TABLE IF EXISTS learn_db.mart_student_lesson_idx;
CREATE TABLE learn_db.mart_student_lesson_idx
(
	`student_profile_id` Int32, -- Идентификатор профиля обучающегося
	`person_id` String, -- GUID обучающегося
	`person_id_int` Int32 CODEC(Delta, ZSTD),
	`educational_organization_id` Int16, -- Идентификатор образовательной организации
	`parallel_id` Int16,
	`class_id` Int16, -- Идентификатор класса
	`lesson_date` Date32, -- Дата урока
	`lesson_month_digits` String,
	`lesson_month_text` String,
	`lesson_year` UInt16,
	`load_date` Date, -- Дата загрузки данных
	`t` Int16 CODEC(Delta, ZSTD),
	`teacher_id` Int32 CODEC(Delta, ZSTD), -- Идентификатор учителя
	`subject_id` Int16 CODEC(Delta, ZSTD), -- Идентификатор предмета
	`subject_name` String,
	`mark` Int8, -- Оценка
	PRIMARY KEY lesson_date
) ENGINE = MergeTree()
AS
SELECT
	student_profile_id,
	person_id,
	person_id_int,
	educational_organization_id,
	parallel_id,
	class_id,
	lesson_date,
	lesson_month_digits,
	lesson_month_text,
	lesson_year,
	load_date,
	t,
	teacher_id,
	subject_id,
	subject_name,
	mark
FROM
	learn_db.mart_student_lesson;
```
       
### 4. Выполняем запрос в clickhouse-client по второй таблице   

```sql
SELECT 
	avg(mark) as avg_m,
	teacher_id
FROM 
	learn_db.mart_student_lesson_idx
WHERE 
	lesson_date = subtractDays(today(), 10)
GROUP BY
	teacher_id
ORDER BY avg_m desc
LIMIT 10;
```

Результат
```text
Query id: cf2d6d78-c77c-45eb-a99d-a85822f039ea

    ┌──────────────avg_m─┬─teacher_id─┐
 1. │                  5 │          4 │
 2. │                  5 │          3 │
 3. │                  5 │         10 │
 4. │                  4 │        618 │
 5. │                  4 │          2 │
 6. │                  4 │        620 │
 7. │ 3.8333333333333335 │         30 │
 8. │                3.8 │         24 │
 9. │ 3.1052631578947367 │         61 │
10. │ 3.0833333333333335 │         14 │
    └────────────────────┴────────────┘

10 rows in set. Elapsed: 0.010 sec. Processed 65.54 thousand rows, 533.73 KB (6.39 million rows/s., 52.06 MB/s.)
Peak memory usage: 1.66 MiB.
```

Запрос выполнился гораздо быстрее и был обработан гораздо меньший объем строк. Скорость обработки упала, но результат ыл получен быстрее.

### 5. Получаем список всех частей данных таблицы mart_student_lesson_idx

```sql
SELECT path FROM system.parts where table = 'mart_student_lesson_idx' AND active = 1;
```

Результат
```text
path                                                                           |
-------------------------------------------------------------------------------+
/var/lib/clickhouse/store/da7/da7b7d14-c077-4e7c-8a23-5c378a702892/all_1_6_1/  |
/var/lib/clickhouse/store/da7/da7b7d14-c077-4e7c-8a23-5c378a702892/all_7_7_0/  |
/var/lib/clickhouse/store/da7/da7b7d14-c077-4e7c-8a23-5c378a702892/all_8_8_0/  |
/var/lib/clickhouse/store/da7/da7b7d14-c077-4e7c-8a23-5c378a702892/all_9_9_0/  |
/var/lib/clickhouse/store/da7/da7b7d14-c077-4e7c-8a23-5c378a702892/all_10_10_0/|
```

Мы получили список из 5 частей данных. Каждая из них хранит строки, отсортированные по полю lesson_date. 


### 6. Получаем строки из 1ой гранулы

```sql
SELECT 
	*
FROM 
	learn_db.mart_student_lesson_idx
ORDER BY lesson_date, person_id_int, mark
LIMIT 8192
OFFSET 8192 * 0;
```

Результат
```text
Query id: 498d85c1-7887-4f0d-9da5-67d37f72945f

      ┌─student_profile_id─┬─person_id─┬─person_id_int─┬─educational_organization_id─┬─parallel_id─┬─class_id─┬─lesson_date─┬─lesson_month_digits─┬─lesson_month_text─┬─lesson_year─┬──load_date─┬───t─┬─teacher_id─┬─subject_id─┬─subject_name────────┬─mark─┐
   1. │                 11 │ 11        │            11 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  72 │         72 │          8 │ Физическая культура │   -1 │
   2. │                 73 │ 73        │            73 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 107 │        107 │         11 │ Информатика         │    4 │
   3. │                162 │ 162       │           162 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 125 │        125 │         13 │ Информатика         │    4 │
   4. │                460 │ 460       │           460 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  84 │         84 │          9 │ Информатика         │    4 │
   5. │                705 │ 705       │           705 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  65 │         65 │          7 │ Биология            │    3 │
   6. │                881 │ 881       │           881 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  89 │         89 │          9 │ Информатика         │   -1 │
   7. │               1142 │ 1142      │          1142 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  92 │         92 │         10 │ Информатика         │   -1 │
   8. │               1199 │ 1199      │          1199 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  76 │         76 │          8 │ Физическая культура │   -1 │
   9. │               1230 │ 1230      │          1230 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │   2 │          2 │          0 │ Информатика         │   -1 │
  10. │               1264 │ 1264      │          1264 │                           0 │           0 │        0 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  59 │         59 │          6 │ География           │   -1 │
8180. │            1219321 │ 1219321   │       1219321 │                           3 │          16 │      609 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │   8 │        462 │          0 │ Информатика         │    4 │
8181. │            1219322 │ 1219322   │       1219322 │                           3 │          16 │      609 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  29 │        483 │          3 │ Литература          │   -1 │
8182. │            1219362 │ 1219362   │       1219362 │                           3 │          16 │      609 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  47 │        501 │          5 │ Химия               │    4 │
8183. │            1219466 │ 1219466   │       1219466 │                           3 │          16 │      609 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 130 │        584 │         14 │ Информатика         │   -1 │
8184. │            1219672 │ 1219672   │       1219672 │                           3 │          16 │      609 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 115 │        569 │         12 │ Информатика         │    4 │
8185. │            1219697 │ 1219697   │       1219697 │                           3 │          16 │      609 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │ 102 │        556 │         11 │ Информатика         │   -1 │
8186. │            1219736 │ 1219736   │       1219736 │                           3 │          16 │      609 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 113 │        567 │         12 │ Информатика         │   -1 │
8187. │            1220243 │ 1220243   │       1220243 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  72 │        526 │          8 │ Физическая культура │    4 │
8188. │            1220393 │ 1220393   │       1220393 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │ 133 │        587 │         14 │ Информатика         │    3 │
8189. │            1220780 │ 1220780   │       1220780 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │   2 │        456 │          0 │ Информатика         │   -1 │
8190. │            1221020 │ 1221020   │       1221020 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  33 │        487 │          3 │ Литература          │   -1 │
8191. │            1221037 │ 1221037   │       1221037 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 100 │        554 │         11 │ Информатика         │    5 │
8192. │            1221132 │ 1221132   │       1221132 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 134 │        588 │         14 │ Информатика         │   -1 │
      └─student_profile_id─┴─person_id─┴─person_id_int─┴─educational_organization_id─┴─parallel_id─┴─class_id─┴─lesson_date─┴─lesson_month_digits─┴─lesson_month_text─┴─lesson_year─┴──load_date─┴───t─┴─teacher_id─┴─subject_id─┴─subject_name────────┴─mark─┘
Showed 1000 out of 8192 rows.
```

В первой строке этой гранулы lesson_date = 2024-11-29.

### 7. Возьмем вторую гранулу

```sql
SELECT 
	*
FROM 
	learn_db.mart_student_lesson_idx
ORDER BY lesson_date, person_id_int, mark
LIMIT 8192
OFFSET 8192 * 1;
```

Результат
```text
Query id: 1b4e5337-6810-4d25-a209-8783ab045875

      ┌─student_profile_id─┬─person_id─┬─person_id_int─┬─educational_organization_id─┬─parallel_id─┬─class_id─┬─lesson_date─┬─lesson_month_digits─┬─lesson_month_text─┬─lesson_year─┬──load_date─┬───t─┬─teacher_id─┬─subject_id─┬─subject_name────────┬─mark─┐
   1. │            1221134 │ 1221134   │       1221134 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  52 │        506 │          5 │ Химия               │   -1 │
   2. │            1221206 │ 1221206   │       1221206 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  72 │        527 │          8 │ Физическая культура │    4 │
   3. │            1221212 │ 1221212   │       1221212 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  46 │        501 │          5 │ Химия               │   -1 │
   4. │            1221228 │ 1221228   │       1221228 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  41 │        496 │          4 │ Физика              │    3 │
   5. │            1221592 │ 1221592   │       1221592 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  18 │        473 │          2 │ Русский язык        │    5 │
   6. │            1221816 │ 1221816   │       1221816 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │   4 │        459 │          0 │ Информатика         │   -1 │
   7. │            1221817 │ 1221817   │       1221817 │                           3 │          16 │      610 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │   5 │        460 │          0 │ Информатика         │    5 │
   8. │            1222054 │ 1222054   │       1222054 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  18 │        473 │          2 │ Русский язык        │    3 │
   9. │            1222177 │ 1222177   │       1222177 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  96 │        551 │         10 │ Информатика         │   -1 │
  10. │            1222306 │ 1222306   │       1222306 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  69 │        524 │          7 │ Биология            │   -1 │
  11. │            1222325 │ 1222325   │       1222325 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  36 │        491 │          4 │ Физика              │   -1 │
  12. │            1222819 │ 1222819   │       1222819 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  78 │        533 │          8 │ Физическая культура │    5 │
  13. │            1222952 │ 1222952   │       1222952 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  86 │        541 │          9 │ Информатика         │    3 │
  14. │            1223379 │ 1223379   │       1223379 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 126 │        581 │         14 │ Информатика         │    5 │
  15. │            1223629 │ 1223629   │       1223629 │                           3 │          16 │      611 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  64 │        519 │          7 │ Биология            │   -1 │
  16. │            1224153 │ 1224153   │       1224153 │                           3 │          16 │      612 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │  88 │        544 │          9 │ Информатика         │    2 │
  17. │            1224343 │ 1224343   │       1224343 │                           3 │          16 │      612 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │   6 │        462 │          0 │ Информатика         │    5 │
  18. │            1224470 │ 1224470   │       1224470 │                           3 │          16 │      612 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 117 │        573 │         13 │ Информатика         │   -1 │
  19. │            1224481 │ 1224481   │       1224481 │                           3 │          16 │      612 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  97 │        553 │         10 │ Информатика         │   -1 │
  20. │            1225271 │ 1225271   │       1225271 │                           3 │          16 │      612 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 119 │        575 │         13 │ Информатика         │   -1 │
...
 495. │            1287060 │ 1287060   │       1287060 │                           3 │          17 │      643 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  36 │        515 │          4 │ Физика              │    4 │
 496. │            1287068 │ 1287068   │       1287068 │                           3 │          17 │      643 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │   5 │        484 │          0 │ Информатика         │    5 │
 497. │            1287530 │ 1287530   │       1287530 │                           3 │          17 │      643 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-29 │ 101 │        580 │         11 │ Информатика         │    4 │
 498. │            1287869 │ 1287869   │       1287869 │                           3 │          17 │      643 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  77 │        556 │          8 │ Физическая культура │   -1 │
 499. │            1288165 │ 1288165   │       1288165 │                           3 │          17 │      644 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 105 │        584 │         11 │ Информатика         │    3 │
 500. │            1288167 │ 1288167   │       1288167 │                           3 │          17 │      644 │  2024-11-29 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  15 │        494 │          1 │ Математика          │   -1 │
      ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─
7693. │             332139 │ 332139    │        332139 │                           0 │           4 │      166 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 134 │        257 │         14 │ Информатика         │    3 │
8180. │             357702 │ 357702    │        357702 │                           0 │           4 │      178 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  78 │        211 │          8 │ Физическая культура │    3 │
8181. │             357780 │ 357780    │        357780 │                           0 │           4 │      178 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  77 │        210 │          8 │ Физическая культура │   -1 │
8182. │             357857 │ 357857    │        357857 │                           0 │           4 │      178 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  67 │        200 │          7 │ Биология            │   -1 │
8183. │             357887 │ 357887    │        357887 │                           0 │           4 │      178 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  83 │        216 │          9 │ Информатика         │   -1 │
8184. │             357892 │ 357892    │        357892 │                           0 │           4 │      178 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 112 │        245 │         12 │ Информатика         │    5 │
8185. │             357913 │ 357913    │        357913 │                           0 │           4 │      178 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 133 │        266 │         14 │ Информатика         │   -1 │
8186. │             358017 │ 358017    │        358017 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  93 │        226 │         10 │ Информатика         │   -1 │
8187. │             358091 │ 358091    │        358091 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  36 │        169 │          4 │ Физика              │   -1 │
8188. │             358240 │ 358240    │        358240 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │ 131 │        264 │         14 │ Информатика         │    3 │
8189. │             358250 │ 358250    │        358250 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  67 │        200 │          7 │ Биология            │   -1 │
8190. │             358290 │ 358290    │        358290 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  89 │        222 │          9 │ Информатика         │   -1 │
8191. │             358387 │ 358387    │        358387 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │ 120 │        253 │         13 │ Информатика         │    4 │
8192. │             358418 │ 358418    │        358418 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │ 117 │        250 │         13 │ Информатика         │    3 │
      └─student_profile_id─┴─person_id─┴─person_id_int─┴─educational_organization_id─┴─parallel_id─┴─class_id─┴─lesson_date─┴─lesson_month_digits─┴─lesson_month_text─┴─lesson_year─┴──load_date─┴───t─┴─teacher_id─┴─subject_id─┴─subject_name────────┴─mark─┘
Showed 1000 out of 8192 rows.

8192 rows in set. Elapsed: 0.934 sec. Processed 10.00 million rows, 1.12 GB (10.70 million rows/s., 1.20 GB/s.)
Peak memory usage: 72.55 MiB.
```

lesson_date равен преимущественно 2024-11-29 и часть значений 2024-11-30.

### 8. Возьмем третью гранулу

```sql
SELECT 
	*
FROM 
	learn_db.mart_student_lesson_idx
ORDER BY lesson_date, person_id_int, mark
LIMIT 8192
OFFSET 8192 * 2;
```

Результат
```text
Query id: 08348d5f-6aa2-47d3-896e-3d763d7d6af1

      ┌─student_profile_id─┬─person_id─┬─person_id_int─┬─educational_organization_id─┬─parallel_id─┬─class_id─┬─lesson_date─┬─lesson_month_digits─┬─lesson_month_text─┬─lesson_year─┬──load_date─┬───t─┬─teacher_id─┬─subject_id─┬─subject_name────────┬─mark─┐
   1. │             358440 │ 358440    │        358440 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  91 │        224 │         10 │ Информатика         │   -1 │
   2. │             358465 │ 358465    │        358465 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 117 │        250 │         13 │ Информатика         │    5 │
   3. │             358501 │ 358501    │        358501 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  21 │        154 │          2 │ Русский язык        │   -1 │
   4. │             358580 │ 358580    │        358580 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  65 │        198 │          7 │ Биология            │    3 │
   5. │             358585 │ 358585    │        358585 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  44 │        177 │          4 │ Физика              │    2 │
   6. │             358628 │ 358628    │        358628 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  12 │        145 │          1 │ Математика          │   -1 │
   7. │             358759 │ 358759    │        358759 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  18 │        151 │          2 │ Русский язык        │   -1 │
   8. │             358774 │ 358774    │        358774 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  96 │        229 │         10 │ Информатика         │    4 │
   9. │             358797 │ 358797    │        358797 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │ 127 │        260 │         14 │ Информатика         │    3 │
  10. │             358821 │ 358821    │        358821 │                           0 │           4 │      179 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  35 │        168 │          3 │ Литература          │    4 │
8180. │             748543 │ 748543    │        748543 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  73 │        351 │          8 │ Физическая культура │    3 │
8181. │             748580 │ 748580    │        748580 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │   4 │        282 │          0 │ Информатика         │   -1 │
8182. │             748664 │ 748664    │        748664 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │   5 │        283 │          0 │ Информатика         │    5 │
8183. │             748674 │ 748674    │        748674 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  29 │        307 │          3 │ Литература          │   -1 │
8184. │             748698 │ 748698    │        748698 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  87 │        365 │          9 │ Информатика         │    3 │
8185. │             748708 │ 748708    │        748708 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  47 │        325 │          5 │ Химия               │   -1 │
8186. │             748741 │ 748741    │        748741 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  70 │        348 │          7 │ Биология            │   -1 │
8187. │             748799 │ 748799    │        748799 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  48 │        327 │          5 │ Химия               │    4 │
8188. │             748822 │ 748822    │        748822 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  64 │        343 │          7 │ Биология            │    3 │
8189. │             748826 │ 748826    │        748826 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  50 │        329 │          5 │ Химия               │    2 │
8190. │             748844 │ 748844    │        748844 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  90 │        369 │         10 │ Информатика         │   -1 │
8191. │             748925 │ 748925    │        748925 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 106 │        385 │         11 │ Информатика         │    3 │
8192. │             748962 │ 748962    │        748962 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  86 │        365 │          9 │ Информатика         │    4 │
      └─student_profile_id─┴─person_id─┴─person_id_int─┴─educational_organization_id─┴─parallel_id─┴─class_id─┴─lesson_date─┴─lesson_month_digits─┴─lesson_month_text─┴─lesson_year─┴──load_date─┴───t─┴─teacher_id─┴─subject_id─┴─subject_name────────┴─mark─┘
Showed 1000 out of 8192 rows.

8192 rows in set. Elapsed: 0.034 sec. Processed 278.53 thousand rows, 31.47 MB (8.24 million rows/s., 931.16 MB/s.)
Peak memory usage: 72.71 MiB.
```

lesson_date = 2024-11-30.

### 9. Возьмем четвертую гранулу

```sql
SELECT 
	*
FROM 
	learn_db.mart_student_lesson_idx
ORDER BY lesson_date, person_id_int, mark
LIMIT 8192
OFFSET 8192 * 3;
```

Результат
```text
Query id: 4b1232c8-592c-4487-a429-082b6f02b222

      ┌─student_profile_id─┬─person_id─┬─person_id_int─┬─educational_organization_id─┬─parallel_id─┬─class_id─┬─lesson_date─┬─lesson_month_digits─┬─lesson_month_text─┬─lesson_year─┬──load_date─┬───t─┬─teacher_id─┬─subject_id─┬─subject_name────────┬─mark─┐
   1. │             748992 │ 748992    │        748992 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  88 │        367 │          9 │ Информатика         │    5 │
   2. │             749003 │ 749003    │        749003 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  25 │        304 │          2 │ Русский язык        │   -1 │
   3. │             749077 │ 749077    │        749077 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 132 │        411 │         14 │ Информатика         │   -1 │
   4. │             749091 │ 749091    │        749091 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 107 │        386 │         11 │ Информатика         │   -1 │
   5. │             749137 │ 749137    │        749137 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  82 │        361 │          9 │ Информатика         │    4 │
   6. │             749158 │ 749158    │        749158 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  44 │        323 │          4 │ Физика              │   -1 │
   7. │             749188 │ 749188    │        749188 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  33 │        312 │          3 │ Литература          │   -1 │
   8. │             749402 │ 749402    │        749402 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  77 │        356 │          8 │ Физическая культура │   -1 │
   9. │             749506 │ 749506    │        749506 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  83 │        362 │          9 │ Информатика         │   -1 │
  10. │             749581 │ 749581    │        749581 │                           2 │          10 │      374 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  25 │        304 │          2 │ Русский язык        │   -1 │
8180. │            1144892 │ 1144892   │       1144892 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 136 │        562 │         15 │ Информатика         │    2 │
8181. │            1144957 │ 1144957   │       1144957 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │ 116 │        542 │         12 │ Информатика         │    2 │
8182. │            1145028 │ 1145028   │       1145028 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  51 │        477 │          5 │ Химия               │   -1 │
8183. │            1145040 │ 1145040   │       1145040 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  14 │        440 │          1 │ Математика          │   -1 │
8184. │            1145083 │ 1145083   │       1145083 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  52 │        478 │          5 │ Химия               │   -1 │
8185. │            1145171 │ 1145171   │       1145171 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  77 │        503 │          8 │ Физическая культура │    4 │
8186. │            1145171 │ 1145171   │       1145171 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │ 120 │        546 │         13 │ Информатика         │    4 │
8187. │            1145418 │ 1145418   │       1145418 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  71 │        497 │          7 │ Биология            │    4 │
8188. │            1145486 │ 1145486   │       1145486 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │ 126 │        552 │         14 │ Информатика         │    3 │
8189. │            1145519 │ 1145519   │       1145519 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  65 │        491 │          7 │ Биология            │   -1 │
8190. │            1145541 │ 1145541   │       1145541 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │ 104 │        530 │         11 │ Информатика         │   -1 │
8191. │            1145552 │ 1145552   │       1145552 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  64 │        490 │          7 │ Биология            │    3 │
8192. │            1145611 │ 1145611   │       1145611 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-01 │  70 │        496 │          7 │ Биология            │   -1 │
      └─student_profile_id─┴─person_id─┴─person_id_int─┴─educational_organization_id─┴─parallel_id─┴─class_id─┴─lesson_date─┴─lesson_month_digits─┴─lesson_month_text─┴─lesson_year─┴──load_date─┴───t─┴─teacher_id─┴─subject_id─┴─subject_name────────┴─mark─┘
Showed 1000 out of 8192 rows.

8192 rows in set. Elapsed: 0.035 sec. Processed 278.53 thousand rows, 31.47 MB (7.90 million rows/s., 892.96 MB/s.)
Peak memory usage: 72.56 MiB.
```

lesson_date = 2024-11-30.

### 10. Возьмем пятую гранулу

```sql
SELECT 
	*
FROM 
	learn_db.mart_student_lesson_idx
ORDER BY lesson_date, person_id_int, mark
LIMIT 8192
OFFSET 8192 * 4;
```

Результат
```text
Query id: 51f9c6f2-5bcc-4f7c-8ca3-8a0cb639a3a9

      ┌─student_profile_id─┬─person_id─┬─person_id_int─┬─educational_organization_id─┬─parallel_id─┬─class_id─┬─lesson_date─┬─lesson_month_digits─┬─lesson_month_text─┬─lesson_year─┬──load_date─┬───t─┬─teacher_id─┬─subject_id─┬─subject_name────────┬─mark─┐
   1. │            1145620 │ 1145620   │       1145620 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  91 │        517 │         10 │ Информатика         │   -1 │
   2. │            1145645 │ 1145645   │       1145645 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  66 │        492 │          7 │ Биология            │   -1 │
   3. │            1145783 │ 1145783   │       1145783 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  51 │        477 │          5 │ Химия               │   -1 │
   4. │            1145819 │ 1145819   │       1145819 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  37 │        463 │          4 │ Физика              │   -1 │
   5. │            1145836 │ 1145836   │       1145836 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │  16 │        442 │          1 │ Математика          │   -1 │
   6. │            1145847 │ 1145847   │       1145847 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 125 │        551 │         13 │ Информатика         │   -1 │
   7. │            1145863 │ 1145863   │       1145863 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  30 │        456 │          3 │ Литература          │    4 │
   8. │            1145876 │ 1145876   │       1145876 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-12-02 │  31 │        457 │          3 │ Литература          │   -1 │
   9. │            1145880 │ 1145880   │       1145880 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │   8 │        434 │          0 │ Информатика         │    4 │
  10. │            1145898 │ 1145898   │       1145898 │                           3 │          15 │      572 │  2024-11-30 │ 2024-11             │ 2024 November     │        2024 │ 2024-11-30 │ 125 │        551 │         13 │ Информатика         │    5 │
─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─
7693. │             210148 │ 210148    │        210148 │                           0 │           2 │      105 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │ 108 │        186 │         12 │ Информатика         │   -1 │
7694. │             210266 │ 210266    │        210266 │                           0 │           2 │      105 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  13 │         91 │          1 │ Математика          │   -1 │
...
8180. │             233729 │ 233729    │        233729 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │ 117 │        204 │         13 │ Информатика         │   -1 │
8181. │             233734 │ 233734    │        233734 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │  44 │        131 │          4 │ Физика              │   -1 │
8182. │             233765 │ 233765    │        233765 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │  33 │        120 │          3 │ Литература          │    4 │
8183. │             233805 │ 233805    │        233805 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │ 105 │        192 │         11 │ Информатика         │    3 │
8184. │             233807 │ 233807    │        233807 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │  75 │        162 │          8 │ Физическая культура │   -1 │
8185. │             233810 │ 233810    │        233810 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │ 121 │        208 │         13 │ Информатика         │    5 │
8186. │             233833 │ 233833    │        233833 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │  54 │        141 │          6 │ География           │    5 │
8187. │             233859 │ 233859    │        233859 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  36 │        123 │          4 │ Физика              │    4 │
8188. │             233925 │ 233925    │        233925 │                           0 │           3 │      116 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  61 │        148 │          6 │ География           │    3 │
8189. │             234012 │ 234012    │        234012 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  14 │        101 │          1 │ Математика          │    5 │
8190. │             234109 │ 234109    │        234109 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  58 │        145 │          6 │ География           │   -1 │
8191. │             234130 │ 234130    │        234130 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │  47 │        134 │          5 │ Химия               │    4 │
8192. │             234178 │ 234178    │        234178 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │  89 │        176 │          9 │ Информатика         │   -1 │
      └─student_profile_id─┴─person_id─┴─person_id_int─┴─educational_organization_id─┴─parallel_id─┴─class_id─┴─lesson_date─┴─lesson_month_digits─┴─lesson_month_text─┴─lesson_year─┴──load_date─┴───t─┴─teacher_id─┴─subject_id─┴─subject_name────────┴─mark─┘
Showed 1000 out of 8192 rows.

8192 rows in set. Elapsed: 0.069 sec. Processed 319.49 thousand rows, 36.13 MB (4.60 million rows/s., 520.60 MB/s.)
Peak memory usage: 72.79 MiB.
```

lesson_date равен преимущественно 2024-11-30 и часть значений 2024-12-01.

### 11. Возьмем шестую гранулу

```sql
SELECT 
	*
FROM 
	learn_db.mart_student_lesson_idx
ORDER BY lesson_date, person_id_int, mark
LIMIT 8192
OFFSET 8192 * 5;
```

Результат
```text
Query id: 7d217e25-6173-44d4-9ea3-04e1a1dbac72

      ┌─student_profile_id─┬─person_id─┬─person_id_int─┬─educational_organization_id─┬─parallel_id─┬─class_id─┬─lesson_date─┬─lesson_month_digits─┬─lesson_month_text─┬─lesson_year─┬──load_date─┬───t─┬─teacher_id─┬─subject_id─┬─subject_name────────┬─mark─┐
   1. │             234198 │ 234198    │        234198 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │   7 │         94 │          0 │ Информатика         │    5 │
   2. │             234281 │ 234281    │        234281 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │ 127 │        214 │         14 │ Информатика         │   -1 │
   3. │             234308 │ 234308    │        234308 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │ 112 │        199 │         12 │ Информатика         │   -1 │
   4. │             234339 │ 234339    │        234339 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │  23 │        110 │          2 │ Русский язык        │   -1 │
   5. │             234369 │ 234369    │        234369 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │ 132 │        219 │         14 │ Информатика         │    3 │
   6. │             234376 │ 234376    │        234376 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │  89 │        176 │          9 │ Информатика         │    5 │
   7. │             234449 │ 234449    │        234449 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  60 │        147 │          6 │ География           │   -1 │
   8. │             234468 │ 234468    │        234468 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │  50 │        137 │          5 │ Химия               │   -1 │
   9. │             234477 │ 234477    │        234477 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │ 113 │        200 │         12 │ Информатика         │    3 │
  10. │             234506 │ 234506    │        234506 │                           0 │           3 │      117 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │ 122 │        209 │         13 │ Информатика         │    5 │
8180. │             622446 │ 622446    │        622446 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  83 │        314 │          9 │ Информатика         │   -1 │
8181. │             622457 │ 622457    │        622457 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │  85 │        316 │          9 │ Информатика         │   -1 │
8182. │             622586 │ 622586    │        622586 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │ 107 │        338 │         11 │ Информатика         │   -1 │
8183. │             622645 │ 622645    │        622645 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │ 127 │        358 │         14 │ Информатика         │   -1 │
8184. │             622660 │ 622660    │        622660 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │ 110 │        342 │         12 │ Информатика         │    4 │
8185. │             622723 │ 622723    │        622723 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-02 │ 125 │        357 │         13 │ Информатика         │   -1 │
8186. │             622767 │ 622767    │        622767 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │  84 │        316 │          9 │ Информатика         │   -1 │
8187. │             622853 │ 622853    │        622853 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  16 │        248 │          1 │ Математика          │   -1 │
8188. │             622854 │ 622854    │        622854 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │ 135 │        367 │         15 │ Информатика         │    2 │
8189. │             622883 │ 622883    │        622883 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │  95 │        327 │         10 │ Информатика         │    2 │
8190. │             622915 │ 622915    │        622915 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │  21 │        253 │          2 │ Русский язык        │    3 │
8191. │             622936 │ 622936    │        622936 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-03 │ 126 │        358 │         14 │ Информатика         │   -1 │
8192. │             622936 │ 622936    │        622936 │                           1 │           8 │      311 │  2024-12-01 │ 2024-12             │ 2024 December     │        2024 │ 2024-12-01 │  56 │        288 │          6 │ География           │    3 │
      └─student_profile_id─┴─person_id─┴─person_id_int─┴─educational_organization_id─┴─parallel_id─┴─class_id─┴─lesson_date─┴─lesson_month_digits─┴─lesson_month_text─┴─lesson_year─┴──load_date─┴───t─┴─teacher_id─┴─subject_id─┴─subject_name────────┴─mark─┘
Showed 1000 out of 8192 rows.

8192 rows in set. Elapsed: 0.049 sec. Processed 319.49 thousand rows, 36.13 MB (6.50 million rows/s., 734.77 MB/s.)
Peak memory usage: 72.62 MiB.
```

lesson_date = 2024-12-01.

По умолчанию в одной грануле 8192 строки. Все строки в таблице делятся на гранулы. И из каждой гранулы берется толька первая строка. И из нее получается значение попадающее в первичный индекс.
Гранула - это минимальная единица, с которой работает ClickHouse. Физически на жестком диске разделения нет. 

granule_id - lesson date

```text
granule_id |lesson date            |
-----------+-----------------------+
0          | 2024-11-29            |
1          | 2024-11-29, 2024-11-30|
2          | 2024-11-30            |
3          | 2024-11-30            |
4          | 2024-11-30            |
5          | 2024-11-30, 2024-12-01|
6          | 2024-12-01            |
```
И теперь, если нам нужно получить только строки с датой, например, 2024-11-29, Clickhouse применит двоичный поиск и выберет только 2 гранулы.  


### 12. Смотрим на гранулы в частях данных

```sql
SELECT * FROM mergeTreeIndex('learn_db', 'mart_student_lesson_idx');
```

Результат
```text
Query id: 5e4ec77f-bf49-43f8-b621-cf999ba9cab6

      ┌─part_name───┬─mark_number─┬─rows_in_granule─┬─lesson_date─┐
   1. │ all_1_6_1   │           0 │            8192 │  2024-11-29 │
   2. │ all_1_6_1   │           1 │            8192 │  2024-11-30 │
   3. │ all_1_6_1   │           2 │            8192 │  2024-11-30 │
   4. │ all_1_6_1   │           3 │            8192 │  2024-12-01 │
   5. │ all_1_6_1   │           4 │            8192 │  2024-12-01 │
   6. │ all_1_6_1   │           5 │            8192 │  2024-12-02 │
   7. │ all_1_6_1   │           6 │            8192 │  2024-12-02 │
   8. │ all_1_6_1   │           7 │            8192 │  2024-12-03 │
   9. │ all_1_6_1   │           8 │            8192 │  2024-12-03 │
  10. │ all_1_6_1   │           9 │            8192 │  2024-12-03 │
  11. │ all_1_6_1   │          10 │            8192 │  2024-12-04 │
  12. │ all_1_6_1   │          11 │            8192 │  2024-12-04 │
  13. │ all_1_6_1   │          12 │            8192 │  2024-12-05 │
  14. │ all_1_6_1   │          13 │            8192 │  2024-12-05 │
  15. │ all_1_6_1   │          14 │            8192 │  2024-12-06 │
  16. │ all_1_6_1   │          15 │            8192 │  2024-12-06 │
  17. │ all_1_6_1   │          16 │            8192 │  2024-12-07 │
  18. │ all_1_6_1   │          17 │            8192 │  2024-12-07 │
  19. │ all_1_6_1   │          18 │            8192 │  2024-12-08 │
  20. │ all_1_6_1   │          19 │            8192 │  2024-12-08 │
  21. │ all_1_6_1   │          20 │            8192 │  2024-12-09 │
  22. │ all_1_6_1   │          21 │            8192 │  2024-12-09 │
  23. │ all_1_6_1   │          22 │            8192 │  2024-12-10 │
  24. │ all_1_6_1   │          23 │            8192 │  2024-12-10 │
  25. │ all_1_6_1   │          24 │            8192 │  2024-12-11 │
  26. │ all_1_6_1   │          25 │            8192 │  2024-12-11 │
  27. │ all_1_6_1   │          26 │            8192 │  2024-12-11 │
  28. │ all_1_6_1   │          27 │            8192 │  2024-12-12 │
  29. │ all_1_6_1   │          28 │            8192 │  2024-12-12 │
  30. │ all_1_6_1   │          29 │            8192 │  2024-12-13 │
  31. │ all_1_6_1   │          30 │            8192 │  2024-12-13 │
  32. │ all_1_6_1   │          31 │            8192 │  2024-12-14 │
  33. │ all_1_6_1   │          32 │            8192 │  2024-12-14 │
  34. │ all_1_6_1   │          33 │            8192 │  2024-12-15 │
  35. │ all_1_6_1   │          34 │            8192 │  2024-12-15 │
  36. │ all_1_6_1   │          35 │            8192 │  2024-12-16 │
  37. │ all_1_6_1   │          36 │            8192 │  2024-12-16 │
  38. │ all_1_6_1   │          37 │            8192 │  2024-12-17 │
  39. │ all_1_6_1   │          38 │            8192 │  2024-12-17 │
  40. │ all_1_6_1   │          39 │            8192 │  2024-12-18 │
  41. │ all_1_6_1   │          40 │            8192 │  2024-12-18 │
  42. │ all_1_6_1   │          41 │            8192 │  2024-12-19 │
  43. │ all_1_6_1   │          42 │            8192 │  2024-12-19 │
  44. │ all_1_6_1   │          43 │            8192 │  2024-12-20 │
  45. │ all_1_6_1   │          44 │            8192 │  2024-12-20 │
  46. │ all_1_6_1   │          45 │            8192 │  2024-12-20 │
  47. │ all_1_6_1   │          46 │            8192 │  2024-12-21 │
  48. │ all_1_6_1   │          47 │            8192 │  2024-12-21 │
  49. │ all_1_6_1   │          48 │            8192 │  2024-12-22 │
  50. │ all_1_6_1   │          49 │            8192 │  2024-12-22 │
  51. │ all_1_6_1   │          50 │            8192 │  2024-12-23 │
  52. │ all_1_6_1   │          51 │            8192 │  2024-12-23 │
  53. │ all_1_6_1   │          52 │            8192 │  2024-12-24 │
  54. │ all_1_6_1   │          53 │            8192 │  2024-12-24 │
  55. │ all_1_6_1   │          54 │            8192 │  2024-12-25 │
  56. │ all_1_6_1   │          55 │            8192 │  2024-12-25 │
  57. │ all_1_6_1   │          56 │            8192 │  2024-12-26 │
  58. │ all_1_6_1   │          57 │            8192 │  2024-12-26 │
  59. │ all_1_6_1   │          58 │            8192 │  2024-12-27 │
  60. │ all_1_6_1   │          59 │            8192 │  2024-12-27 │
  61. │ all_1_6_1   │          60 │            8192 │  2024-12-28 │
  62. │ all_1_6_1   │          61 │            8192 │  2024-12-28 │
  63. │ all_1_6_1   │          62 │            8192 │  2024-12-29 │
  64. │ all_1_6_1   │          63 │            8192 │  2024-12-29 │
  65. │ all_1_6_1   │          64 │            8192 │  2024-12-30 │
  66. │ all_1_6_1   │          65 │            8192 │  2024-12-30 │
  67. │ all_1_6_1   │          66 │            8192 │  2024-12-30 │
  68. │ all_1_6_1   │          67 │            8192 │  2024-12-31 │
  69. │ all_1_6_1   │          68 │            8192 │  2024-12-31 │
  70. │ all_1_6_1   │          69 │            8192 │  2025-01-01 │
  71. │ all_1_6_1   │          70 │            8192 │  2025-01-01 │
  72. │ all_1_6_1   │          71 │            8192 │  2025-01-02 │
  73. │ all_1_6_1   │          72 │            8192 │  2025-01-02 │
  74. │ all_1_6_1   │          73 │            8192 │  2025-01-03 │
  75. │ all_1_6_1   │          74 │            8192 │  2025-01-03 │
  76. │ all_1_6_1   │          75 │            8192 │  2025-01-04 │
  77. │ all_1_6_1   │          76 │            8192 │  2025-01-04 │
  78. │ all_1_6_1   │          77 │            8192 │  2025-01-05 │
  79. │ all_1_6_1   │          78 │            8192 │  2025-01-05 │
  80. │ all_1_6_1   │          79 │            8192 │  2025-01-06 │
  81. │ all_1_6_1   │          80 │            8192 │  2025-01-06 │
  82. │ all_1_6_1   │          81 │            8192 │  2025-01-07 │
  83. │ all_1_6_1   │          82 │            8192 │  2025-01-07 │
  84. │ all_1_6_1   │          83 │            8192 │  2025-01-08 │
  85. │ all_1_6_1   │          84 │            8192 │  2025-01-08 │
  86. │ all_1_6_1   │          85 │            8192 │  2025-01-09 │
  87. │ all_1_6_1   │          86 │            8192 │  2025-01-09 │
  88. │ all_1_6_1   │          87 │            8192 │  2025-01-09 │
  89. │ all_1_6_1   │          88 │            8192 │  2025-01-10 │
  90. │ all_1_6_1   │          89 │            8192 │  2025-01-10 │
  91. │ all_1_6_1   │          90 │            8192 │  2025-01-11 │
  92. │ all_1_6_1   │          91 │            8192 │  2025-01-11 │
  93. │ all_1_6_1   │          92 │            8192 │  2025-01-12 │
  94. │ all_1_6_1   │          93 │            8192 │  2025-01-12 │
  95. │ all_1_6_1   │          94 │            8192 │  2025-01-13 │
  96. │ all_1_6_1   │          95 │            8192 │  2025-01-13 │
  97. │ all_1_6_1   │          96 │            8192 │  2025-01-14 │
  98. │ all_1_6_1   │          97 │            8192 │  2025-01-14 │
  99. │ all_1_6_1   │          98 │            8192 │  2025-01-15 │
 100. │ all_1_6_1   │          99 │            8192 │  2025-01-15 │
 101. │ all_1_6_1   │         100 │            8192 │  2025-01-16 │
 102. │ all_1_6_1   │         101 │            8192 │  2025-01-16 │
 103. │ all_1_6_1   │         102 │            8192 │  2025-01-17 │
 104. │ all_1_6_1   │         103 │            8192 │  2025-01-17 │
 105. │ all_1_6_1   │         104 │            8192 │  2025-01-17 │
 106. │ all_1_6_1   │         105 │            8192 │  2025-01-18 │
 107. │ all_1_6_1   │         106 │            8192 │  2025-01-18 │
 108. │ all_1_6_1   │         107 │            8192 │  2025-01-19 │
 109. │ all_1_6_1   │         108 │            8192 │  2025-01-19 │
 110. │ all_1_6_1   │         109 │            8192 │  2025-01-20 │
 111. │ all_1_6_1   │         110 │            8192 │  2025-01-20 │
...
 490. │ all_1_6_1   │         489 │            8192 │  2025-07-19 │
 491. │ all_1_6_1   │         490 │            8192 │  2025-07-20 │
 492. │ all_1_6_1   │         491 │            8192 │  2025-07-20 │
 493. │ all_1_6_1   │         492 │            8192 │  2025-07-21 │
 494. │ all_1_6_1   │         493 │            8192 │  2025-07-21 │
 495. │ all_1_6_1   │         494 │            8192 │  2025-07-21 │
 496. │ all_1_6_1   │         495 │            8192 │  2025-07-22 │
 497. │ all_1_6_1   │         496 │            8192 │  2025-07-22 │
 498. │ all_1_6_1   │         497 │            8192 │  2025-07-23 │
 499. │ all_1_6_1   │         498 │            8192 │  2025-07-23 │
 500. │ all_1_6_1   │         499 │            8192 │  2025-07-24 │
      ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─
 732. │ all_1_6_1   │         731 │            8192 │  2025-11-11 │
 733. │ all_1_6_1   │         732 │            8192 │  2025-11-11 │
 734. │ all_1_6_1   │         733 │            8192 │  2025-11-12 │
 735. │ all_1_6_1   │         734 │            8192 │  2025-11-12 │
 736. │ all_1_6_1   │         735 │            8192 │  2025-11-13 │
 737. │ all_1_6_1   │         736 │            8192 │  2025-11-13 │
 738. │ all_1_6_1   │         737 │            8192 │  2025-11-14 │
 739. │ all_1_6_1   │         738 │            8192 │  2025-11-14 │
 740. │ all_1_6_1   │         739 │            8192 │  2025-11-15 │
 741. │ all_1_6_1   │         740 │            8192 │  2025-11-15 │
 742. │ all_1_6_1   │         741 │            8192 │  2025-11-16 │
 743. │ all_1_6_1   │         742 │            8192 │  2025-11-16 │
 744. │ all_1_6_1   │         743 │            8192 │  2025-11-16 │
 745. │ all_1_6_1   │         744 │            8192 │  2025-11-17 │
 746. │ all_1_6_1   │         745 │            8192 │  2025-11-17 │
 747. │ all_1_6_1   │         746 │            8192 │  2025-11-18 │
 748. │ all_1_6_1   │         747 │            8192 │  2025-11-18 │
 749. │ all_1_6_1   │         748 │            8192 │  2025-11-19 │
 750. │ all_1_6_1   │         749 │            8192 │  2025-11-19 │
 751. │ all_1_6_1   │         750 │            8192 │  2025-11-20 │
 752. │ all_1_6_1   │         751 │            8192 │  2025-11-20 │
 753. │ all_1_6_1   │         752 │            8192 │  2025-11-21 │
 754. │ all_1_6_1   │         753 │            8192 │  2025-11-21 │
 755. │ all_1_6_1   │         754 │            8192 │  2025-11-22 │
 756. │ all_1_6_1   │         755 │            8192 │  2025-11-22 │
 757. │ all_1_6_1   │         756 │            8192 │  2025-11-23 │
 758. │ all_1_6_1   │         757 │            8192 │  2025-11-23 │
 759. │ all_1_6_1   │         758 │            8192 │  2025-11-24 │
 760. │ all_1_6_1   │         759 │            8192 │  2025-11-24 │
 761. │ all_1_6_1   │         760 │            8192 │  2025-11-25 │
 762. │ all_1_6_1   │         761 │            8192 │  2025-11-25 │
 763. │ all_1_6_1   │         762 │            8192 │  2025-11-25 │
 764. │ all_1_6_1   │         763 │            8192 │  2025-11-26 │
 765. │ all_1_6_1   │         764 │            7891 │  2025-11-26 │
 766. │ all_1_6_1   │         765 │            8192 │  2025-11-27 │
 767. │ all_1_6_1   │         766 │            7377 │  2025-11-27 │
 768. │ all_1_6_1   │         767 │            8029 │  2025-11-28 │
 769. │ all_1_6_1   │         768 │            6628 │  2025-11-28 │
 770. │ all_1_6_1   │         769 │            3467 │  2025-11-29 │
 771. │ all_1_6_1   │         770 │            4029 │  2025-11-29 │
 772. │ all_1_6_1   │         771 │            1216 │  2025-11-29 │
 773. │ all_1_6_1   │         772 │               0 │  2025-11-29 │
 774. │ all_7_7_0   │           0 │            8192 │  2024-11-29 │
 775. │ all_7_7_0   │           1 │            8192 │  2024-12-02 │
 776. │ all_7_7_0   │           2 │            8192 │  2024-12-05 │
 777. │ all_7_7_0   │           3 │            8192 │  2024-12-08 │
 778. │ all_7_7_0   │           4 │            8192 │  2024-12-11 │
 779. │ all_7_7_0   │           5 │            8192 │  2024-12-13 │
 780. │ all_7_7_0   │           6 │            8192 │  2024-12-16 │
 781. │ all_7_7_0   │           7 │            8192 │  2024-12-19 │
 782. │ all_7_7_0   │           8 │            8192 │  2024-12-22 │
 783. │ all_7_7_0   │           9 │            8192 │  2024-12-25 │
 784. │ all_7_7_0   │          10 │            8192 │  2024-12-28 │
 785. │ all_7_7_0   │          11 │            8192 │  2024-12-30 │
 786. │ all_7_7_0   │          12 │            8192 │  2025-01-02 │
 787. │ all_7_7_0   │          13 │            8192 │  2025-01-05 │
 788. │ all_7_7_0   │          14 │            8192 │  2025-01-08 │
 789. │ all_7_7_0   │          15 │            8192 │  2025-01-11 │
 790. │ all_7_7_0   │          16 │            8192 │  2025-01-14 │
...
 901. │ all_7_7_0   │         127 │            8192 │  2025-11-25 │
 902. │ all_7_7_0   │         128 │            3954 │  2025-11-28 │
 903. │ all_7_7_0   │         129 │               0 │  2025-11-29 │
 904. │ all_8_8_0   │           0 │            8192 │  2024-11-29 │
 905. │ all_8_8_0   │           1 │            8192 │  2024-12-02 │
 906. │ all_8_8_0   │           2 │            8192 │  2024-12-05 │
 907. │ all_8_8_0   │           3 │            8192 │  2024-12-08 │
 908. │ all_8_8_0   │           4 │            8192 │  2024-12-11 │
 909. │ all_8_8_0   │           5 │            8192 │  2024-12-13 │
 910. │ all_8_8_0   │           6 │            8192 │  2024-12-16 │
 911. │ all_8_8_0   │           7 │            8192 │  2024-12-19 │
 912. │ all_8_8_0   │           8 │            8192 │  2024-12-22 │
 913. │ all_8_8_0   │           9 │            8192 │  2024-12-25 │
 914. │ all_8_8_0   │          10 │            8192 │  2024-12-27 │
 915. │ all_8_8_0   │          11 │            8192 │  2024-12-30 │
 916. │ all_8_8_0   │          12 │            8192 │  2025-01-02 │
 917. │ all_8_8_0   │          13 │            8192 │  2025-01-05 │
 918. │ all_8_8_0   │          14 │            8192 │  2025-01-08 │
...
1030. │ all_8_8_0   │         126 │            8192 │  2025-11-22 │
1031. │ all_8_8_0   │         127 │            8192 │  2025-11-25 │
1032. │ all_8_8_0   │         128 │            2973 │  2025-11-28 │
1033. │ all_8_8_0   │         129 │               0 │  2025-11-29 │
1034. │ all_9_9_0   │           0 │            8192 │  2024-11-29 │
1035. │ all_9_9_0   │           1 │            8192 │  2024-12-02 │
1036. │ all_9_9_0   │           2 │            8192 │  2024-12-05 │
1037. │ all_9_9_0   │           3 │            8192 │  2024-12-08 │
1038. │ all_9_9_0   │           4 │            8192 │  2024-12-10 │
1039. │ all_9_9_0   │           5 │            8192 │  2024-12-13 │
1040. │ all_9_9_0   │           6 │            8192 │  2024-12-16 │
1041. │ all_9_9_0   │           7 │            8192 │  2024-12-19 │
1042. │ all_9_9_0   │           8 │            8192 │  2024-12-22 │
1043. │ all_9_9_0   │           9 │            8192 │  2024-12-25 │
1044. │ all_9_9_0   │          10 │            8192 │  2024-12-28 │
1045. │ all_9_9_0   │          11 │            8192 │  2024-12-30 │
1046. │ all_9_9_0   │          12 │            8192 │  2025-01-02 │
1047. │ all_9_9_0   │          13 │            8192 │  2025-01-05 │
...
1150. │ all_9_9_0   │         116 │            8192 │  2025-10-26 │
1151. │ all_9_9_0   │         117 │            8192 │  2025-10-29 │
1152. │ all_9_9_0   │         118 │            8192 │  2025-11-01 │
1153. │ all_9_9_0   │         119 │            8192 │  2025-11-03 │
1154. │ all_9_9_0   │         120 │            8192 │  2025-11-06 │
1155. │ all_9_9_0   │         121 │            8192 │  2025-11-09 │
1156. │ all_9_9_0   │         122 │            8192 │  2025-11-12 │
1157. │ all_9_9_0   │         123 │            8192 │  2025-11-15 │
1158. │ all_9_9_0   │         124 │            8192 │  2025-11-18 │
1159. │ all_9_9_0   │         125 │            8192 │  2025-11-21 │
1160. │ all_9_9_0   │         126 │            8192 │  2025-11-23 │
1161. │ all_9_9_0   │         127 │            8192 │  2025-11-26 │
1162. │ all_9_9_0   │         128 │              97 │  2025-11-29 │
1163. │ all_9_9_0   │         129 │               0 │  2025-11-29 │
1164. │ all_10_10_0 │           0 │            8192 │  2024-11-29 │
1165. │ all_10_10_0 │           1 │            8192 │  2024-12-05 │
1166. │ all_10_10_0 │           2 │            8192 │  2024-12-10 │
1167. │ all_10_10_0 │           3 │            8192 │  2024-12-16 │
1168. │ all_10_10_0 │           4 │            8192 │  2024-12-21 │
1169. │ all_10_10_0 │           5 │            8192 │  2024-12-27 │
1170. │ all_10_10_0 │           6 │            8192 │  2025-01-01 │
1171. │ all_10_10_0 │           7 │            8192 │  2025-01-07 │
1172. │ all_10_10_0 │           8 │            8192 │  2025-01-12 │
1173. │ all_10_10_0 │           9 │            8192 │  2025-01-18 │
1174. │ all_10_10_0 │          10 │            8192 │  2025-01-23 │
1175. │ all_10_10_0 │          11 │            8192 │  2025-01-29 │
1176. │ all_10_10_0 │          12 │            8192 │  2025-02-04 │
1177. │ all_10_10_0 │          13 │            8192 │  2025-02-09 │
1178. │ all_10_10_0 │          14 │            8192 │  2025-02-15 │
1179. │ all_10_10_0 │          15 │            8192 │  2025-02-20 │
1180. │ all_10_10_0 │          16 │            8192 │  2025-02-26 │
1181. │ all_10_10_0 │          17 │            8192 │  2025-03-03 │
1182. │ all_10_10_0 │          18 │            8192 │  2025-03-09 │
1183. │ all_10_10_0 │          19 │            8192 │  2025-03-14 │
1184. │ all_10_10_0 │          20 │            8192 │  2025-03-20 │
1185. │ all_10_10_0 │          21 │            8192 │  2025-03-25 │
1186. │ all_10_10_0 │          22 │            8192 │  2025-03-31 │
1187. │ all_10_10_0 │          23 │            8192 │  2025-04-05 │
1188. │ all_10_10_0 │          24 │            8192 │  2025-04-11 │
1189. │ all_10_10_0 │          25 │            8192 │  2025-04-17 │
1190. │ all_10_10_0 │          26 │            8192 │  2025-04-22 │
1191. │ all_10_10_0 │          27 │            8192 │  2025-04-28 │
1192. │ all_10_10_0 │          28 │            8192 │  2025-05-03 │
1193. │ all_10_10_0 │          29 │            8192 │  2025-05-09 │
1194. │ all_10_10_0 │          30 │            8192 │  2025-05-14 │
1195. │ all_10_10_0 │          31 │            8192 │  2025-05-20 │
1196. │ all_10_10_0 │          32 │            8192 │  2025-05-25 │
1197. │ all_10_10_0 │          33 │            8192 │  2025-05-31 │
1198. │ all_10_10_0 │          34 │            8192 │  2025-06-05 │
1199. │ all_10_10_0 │          35 │            8192 │  2025-06-11 │
1200. │ all_10_10_0 │          36 │            8192 │  2025-06-16 │
1201. │ all_10_10_0 │          37 │            8192 │  2025-06-22 │
1202. │ all_10_10_0 │          38 │            8192 │  2025-06-27 │
1203. │ all_10_10_0 │          39 │            8192 │  2025-07-03 │
1204. │ all_10_10_0 │          40 │            8192 │  2025-07-08 │
1205. │ all_10_10_0 │          41 │            8192 │  2025-07-14 │
1206. │ all_10_10_0 │          42 │            8192 │  2025-07-20 │
1207. │ all_10_10_0 │          43 │            8192 │  2025-07-25 │
1208. │ all_10_10_0 │          44 │            8192 │  2025-07-31 │
1209. │ all_10_10_0 │          45 │            8192 │  2025-08-05 │
1210. │ all_10_10_0 │          46 │            8192 │  2025-08-11 │
1211. │ all_10_10_0 │          47 │            8192 │  2025-08-16 │
1212. │ all_10_10_0 │          48 │            8192 │  2025-08-22 │
1213. │ all_10_10_0 │          49 │            8192 │  2025-08-27 │
1214. │ all_10_10_0 │          50 │            8192 │  2025-09-02 │
1215. │ all_10_10_0 │          51 │            8192 │  2025-09-07 │
1216. │ all_10_10_0 │          52 │            8192 │  2025-09-12 │
1217. │ all_10_10_0 │          53 │            8192 │  2025-09-18 │
1218. │ all_10_10_0 │          54 │            8192 │  2025-09-23 │
1219. │ all_10_10_0 │          55 │            8192 │  2025-09-29 │
1220. │ all_10_10_0 │          56 │            8192 │  2025-10-04 │
1221. │ all_10_10_0 │          57 │            8192 │  2025-10-10 │
1222. │ all_10_10_0 │          58 │            8192 │  2025-10-15 │
1223. │ all_10_10_0 │          59 │            8192 │  2025-10-21 │
1224. │ all_10_10_0 │          60 │            8192 │  2025-10-26 │
1225. │ all_10_10_0 │          61 │            8192 │  2025-11-01 │
1226. │ all_10_10_0 │          62 │            8192 │  2025-11-06 │
1227. │ all_10_10_0 │          63 │            8192 │  2025-11-12 │
1228. │ all_10_10_0 │          64 │            8192 │  2025-11-17 │
1229. │ all_10_10_0 │          65 │            8192 │  2025-11-23 │
1230. │ all_10_10_0 │          66 │            1059 │  2025-11-28 │
1231. │ all_10_10_0 │          67 │               0 │  2025-11-29 │
      └─part_name───┴─mark_number─┴─rows_in_granule─┴─lesson_date─┘
Showed 1000 out of 1231 rows.

1231 rows in set. Elapsed: 0.002 sec. Processed 1.23 thousand rows, 46.91 KB (684.50 thousand rows/s., 26.09 MB/s.)
Peak memory usage: 62.95 KiB.
```

На одну гранула одна строка. И по каждой грануле указано сколько в ней всего строк, в какой части данных она расположена (part_name), и какая по счету это гранула в парте (mark_number).
По каждой грануле видим значение засечки (lesson_date), которые в нее попадают.

### 13. Смотрим на засечки в каждой части данных

```sql
SELECT
    part_name,
    max(mark_number) as entries
FROM mergeTreeIndex('learn_db', 'mart_student_lesson_idx')
GROUP BY part_name;
```

Результат
```text
Query id: 728e67c0-e868-41c8-80df-2af6ec72c747

   ┌─part_name───┬─entries─┐
1. │ all_9_9_0   │     129 │
2. │ all_10_10_0 │      67 │
3. │ all_8_8_0   │     129 │
4. │ all_1_6_1   │     772 │
5. │ all_7_7_0   │     129 │
   └─────────────┴─────────┘

5 rows in set. Elapsed: 0.002 sec. Processed 1.23 thousand rows, 32.14 KB (522.70 thousand rows/s., 13.65 MB/s.)
Peak memory usage: 60.09 KiB.
```

Он покажет сколько гранул в каждой части данных.

### 14. Смотрим план выполнения запроса со статистикой по применению индекса

```sql
EXPLAIN indexes = 1
SELECT 
	avg(mark) as avg_m,
	teacher_id
FROM 
	learn_db.mart_student_lesson_idx
WHERE 
	lesson_date = subtractDays(today(), 10)
GROUP BY
	teacher_id
ORDER BY avg_m desc
LIMIT 10;
```

Результат
```text 
explain                                                           |
------------------------------------------------------------------+
Expression (Project names)                                        |
  Limit (preliminary LIMIT (without OFFSET))                      |
    Sorting (Sorting for ORDER BY)                                |
      Expression ((Before ORDER BY + Projection))                 |
        Aggregating                                               |
          Expression (Before GROUP BY)                            |
            Expression                                            |
              ReadFromMergeTree (learn_db.mart_student_lesson_idx)|
              Indexes:                                            |
                PrimaryKey                                        |
                  Keys:                                           |
                    lesson_date                                   |
                  Condition: (lesson_date in [20341, 20341])      |
                  Parts: 5/5                                      |
                  Granules: 8/1225                                |
```

Видим что был применен индекс PrimaryKey и с помощью него произошла фильтрация.

### 15. Пересоздаем таблицу с размером гранулы 4096

```sql
DROP TABLE IF EXISTS learn_db.mart_student_lesson_idx;
CREATE TABLE learn_db.mart_student_lesson_idx
(
	`student_profile_id` Int32, -- Идентификатор профиля обучающегося
	`person_id` String, -- GUID обучающегося
	`person_id_int` Int32 CODEC(Delta, ZSTD),
	`educational_organization_id` Int16, -- Идентификатор образовательной организации
	`parallel_id` Int16,
	`class_id` Int16, -- Идентификатор класса
	`lesson_date` Date32, -- Дата урока
	`lesson_month_digits` String,
	`lesson_month_text` String,
	`lesson_year` UInt16,
	`load_date` Date, -- Дата загрузки данных
	`t` Int16 CODEC(Delta, ZSTD),
	`teacher_id` Int32 CODEC(Delta, ZSTD), -- Идентификатор учителя
	`subject_id` Int16 CODEC(Delta, ZSTD), -- Идентификатор предмета
	`subject_name` String,
	`mark` Int8, -- Оценка
	PRIMARY KEY lesson_date
) ENGINE = MergeTree()
SETTINGS index_granularity = 4096
AS
SELECT
	student_profile_id,
	person_id,
	person_id_int,
	educational_organization_id,
	parallel_id,
	class_id,
	lesson_date,
	lesson_month_digits,
	lesson_month_text,
	lesson_year,
	load_date,
	t,
	teacher_id,
	subject_id,
	subject_name,
	mark
FROM
	learn_db.mart_student_lesson;
```

### 16. Пересоздаем таблицу с индексом по трем столбцам

```sql
DROP TABLE IF EXISTS learn_db.mart_student_lesson_idx;
CREATE TABLE learn_db.mart_student_lesson_idx
(
	`student_profile_id` Int32, -- Идентификатор профиля обучающегося
	`person_id` String, -- GUID обучающегося
	`person_id_int` Int32 CODEC(Delta, ZSTD),
	`educational_organization_id` Int16, -- Идентификатор образовательной организации
	`parallel_id` Int16,
	`class_id` Int16, -- Идентификатор класса
	`lesson_date` Date32, -- Дата урока
	`lesson_month_digits` String,
	`lesson_month_text` String,
	`lesson_year` UInt16,
	`load_date` Date, -- Дата загрузки данных
	`t` Int16 CODEC(Delta, ZSTD),
	`teacher_id` Int32 CODEC(Delta, ZSTD), -- Идентификатор учителя
	`subject_id` Int16 CODEC(Delta, ZSTD), -- Идентификатор предмета
	`subject_name` String,
	`mark` Int8, -- Оценка
	PRIMARY KEY (lesson_date, person_id_int, mark)
) ENGINE = MergeTree()
AS
SELECT
	student_profile_id,
	person_id,
	person_id_int,
	educational_organization_id,
	parallel_id,
	class_id,
	lesson_date,
	lesson_month_digits,
	lesson_month_text,
	lesson_year,
	load_date,
	t,
	teacher_id,
	subject_id,
	subject_name,
	mark
FROM
	learn_db.mart_student_lesson;
```

### 17. Смотрим эффективность фильтрации по второму полю в индексе

```sql
EXPLAIN indexes = 1
SELECT 
	avg(mark) as avg_m,
	teacher_id
FROM 
	learn_db.mart_student_lesson_idx
WHERE 
	person_id_int = 1000
GROUP BY
	teacher_id
ORDER BY avg_m desc
LIMIT 10;
```

Результат
```text
explain                                                           |
------------------------------------------------------------------+
Expression (Project names)                                        |
  Limit (preliminary LIMIT (without OFFSET))                      |
    Sorting (Sorting for ORDER BY)                                |
      Expression ((Before ORDER BY + Projection))                 |
        Aggregating                                               |
          Expression (Before GROUP BY)                            |
            Expression                                            |
              ReadFromMergeTree (learn_db.mart_student_lesson_idx)|
              Indexes:                                            |
                PrimaryKey                                        |
                  Keys:                                           |
                    person_id_int                                 |
                  Condition: (person_id_int in [1000, 1000])      |
                  Parts: 5/5                                      |
                  Granules: 821/1225                              |
```

### 18. Смотрим, в какое количество частей данный попадает на самом деле person_id_int = 1000

```sql
SELECT DISTINCT 
	_part
FROM 
	learn_db.mart_student_lesson_idx
WHERE 
	person_id_int = 1000;
```

Результат
```text
_part    |
---------+
all_9_9_0|
all_7_7_0|
all_1_6_1|
all_8_8_0|
```

### 19. Получаем строки первой гранулы

```sql
SELECT 
	lesson_date, person_id_int, mark
FROM 
	learn_db.mart_student_lesson_idx
ORDER BY 
	lesson_date, person_id_int, mark
LIMIT 8192
OFFSET 8192 * 0;
```

Результат
```text
lesson_date|person_id_int|mark|
-----------+-------------+----+
 2024-09-20|           17|  -1|
 2024-09-20|           93|  -1|
 2024-09-20|          126|   3|
 2024-09-20|          397|  -1|
 2024-09-20|          401|   4|
 2024-09-20|          404|  -1|
 2024-09-20|          419|   4|
 2024-09-20|          436|   2|
 2024-09-20|          458|   4|
 2024-09-20|          495|   3|
 2024-09-20|          516|   4|
 2024-09-20|          518|   5|
 2024-09-20|          639|   5|
 2024-09-20|          664|   4|
 2024-09-20|          705|   2|
 2024-09-20|          730|   5|
 2024-09-20|          732|  -1|
 2024-09-20|          745|   3|
 2024-09-20|          746|   4|
 2024-09-20|          752|  -1|
 2024-09-20|          764|   4|
 2024-09-20|          835|  -1|
 2024-09-20|          836|   2|
 2024-09-20|          870|   3|
 2024-09-20|          917|   4|
 2024-09-20|          984|   2|
 2024-09-20|         1053|  -1|
 2024-09-20|         1057|   3|
 2024-09-20|         1160|  -1|
 2024-09-20|         1336|  -1|
 2024-09-20|         1408|  -1|
 2024-09-20|         1429|   2|
 2024-09-20|         1495|  -1|
 2024-09-20|         1506|   4|
 2024-09-20|         1507|   2|
 2024-09-20|         1545|   4|
 2024-09-20|         1584|   4|
 2024-09-20|         1621|  -1|
 2024-09-20|         1680|   3|
 2024-09-20|         1858|   3|
 2024-09-20|         2093|   5|
 2024-09-20|         2175|  -1|
 2024-09-20|         2339|   3|
 2024-09-20|         2434|   5|
 2024-09-20|         2451|  -1|
 2024-09-20|         2552|   2|
 2024-09-20|         2600|   4|
 2024-09-20|         2643|  -1|
 2024-09-20|         2653|  -1|
 2024-09-20|         2678|  -1|
 2024-09-20|         2694|   4|
 2024-09-20|         2719|  -1|
 2024-09-20|         2794|   4|
 2024-09-20|         2798|  -1|
 2024-09-20|         2832|  -1|
 2024-09-20|         2854|  -1|
 2024-09-20|         2965|  -1|
 2024-09-20|         3084|   4|
 2024-09-20|         3166|   4|
 2024-09-20|         3595|  -1|
 2024-09-20|         3863|  -1|
 2024-09-20|         3906|  -1|
 2024-09-20|         3907|  -1|
 2024-09-20|         4116|   5|
 2024-09-20|         4139|   4|
 2024-09-20|         4190|  -1|
 2024-09-20|         4246|   2|
 2024-09-20|         4252|   4|
 2024-09-20|         4314|  -1|
 2024-09-20|         4332|   5|
 2024-09-20|         4361|   4|
 2024-09-20|         4396|   5|
 2024-09-20|         4498|   4|
 2024-09-20|         4522|  -1|
 2024-09-20|         4535|   3|
 2024-09-20|         4545|   5|
 2024-09-20|         4635|   4|
 2024-09-20|         4661|   2|
 2024-09-20|         4863|  -1|
 2024-09-20|         4919|  -1|
 2024-09-20|         5047|   4|
 2024-09-20|         5173|   5|
 2024-09-20|         5197|   4|
 2024-09-20|         5239|   4|
 2024-09-20|         5299|   2|
 2024-09-20|         5384|   4|
 2024-09-20|         5441|  -1|
 2024-09-20|         5516|  -1|
 2024-09-20|         5627|  -1|
 2024-09-20|         5754|  -1|
 2024-09-20|         5812|   3|
 2024-09-20|         5842|   4|
 2024-09-20|         5848|   4|
 2024-09-20|         5878|  -1|
 2024-09-20|         5920|   4|
 2024-09-20|         5932|  -1|
 2024-09-20|         5980|  -1|
 2024-09-20|         5989|  -1|
 2024-09-20|         6104|  -1|
 2024-09-20|         6110|  -1|
 2024-09-20|         6318|  -1|
 2024-09-20|         6382|  -1|
 2024-09-20|         6398|   3|
 2024-09-20|         6420|  -1|
 2024-09-20|         6420|  -1|
 2024-09-20|         6517|  -1|
 2024-09-20|         6649|  -1|
 2024-09-20|         6714|  -1|
 2024-09-20|         6721|   5|
 2024-09-20|         6869|  -1|
 2024-09-20|         6965|  -1|
 2024-09-20|         7099|  -1|
 2024-09-20|         7153|  -1|
 2024-09-20|         7160|   5|
 2024-09-20|         7170|  -1|
 2024-09-20|         7217|  -1|
 2024-09-20|         7254|  -1|
 2024-09-20|         7307|  -1|
 2024-09-20|         7321|   5|
 2024-09-20|         7337|  -1|
 2024-09-20|         7343|  -1|
 2024-09-20|         7369|  -1|
 2024-09-20|         7382|  -1|
 2024-09-20|         7429|  -1|
 2024-09-20|         7429|   5|
 2024-09-20|         7580|  -1|
 2024-09-20|         7692|  -1|
 2024-09-20|         7888|  -1|
 2024-09-20|         7904|   3|
 2024-09-20|         7927|   3|
 2024-09-20|         7966|   2|
 2024-09-20|         8137|   5|
 2024-09-20|         8143|   2|
 2024-09-20|         8181|  -1|
 2024-09-20|         8192|   2|
 2024-09-20|         8196|  -1|
 2024-09-20|         8225|   4|
 2024-09-20|         8382|  -1|
 2024-09-20|         8588|  -1|
 2024-09-20|         8711|   4|
 2024-09-20|         8777|   5|
 2024-09-20|         8955|   3|
 2024-09-20|         8962|  -1|
 2024-09-20|         8992|   4|
 2024-09-20|         9007|  -1|
 2024-09-20|         9028|  -1|
 2024-09-20|         9062|  -1|
 2024-09-20|         9068|   4|
 2024-09-20|         9189|   3|
 2024-09-20|         9229|  -1|
 2024-09-20|         9236|   4|
 2024-09-20|         9272|   3|
 2024-09-20|         9322|   4|
 2024-09-20|         9346|   4|
 2024-09-20|         9451|  -1|
 2024-09-20|         9472|  -1|
 2024-09-20|         9572|   4|
 2024-09-20|         9596|  -1|
 2024-09-20|         9682|   4|
 2024-09-20|         9698|   3|
 2024-09-20|         9830|   3|
 2024-09-20|         9864|  -1|
 2024-09-20|         9886|  -1|
 2024-09-20|         9909|   5|
 2024-09-20|         9915|   3|
 2024-09-20|         9934|  -1|
 2024-09-20|        10067|  -1|
 2024-09-20|        10112|  -1|
 2024-09-20|        10121|  -1|
 2024-09-20|        10228|   2|
 2024-09-20|        10278|  -1|
 2024-09-20|        10307|  -1|
 2024-09-20|        10307|   4|
 2024-09-20|        10403|  -1|
 2024-09-20|        10539|  -1|
 2024-09-20|        10611|   5|
 2024-09-20|        10638|  -1|
 2024-09-20|        10655|  -1|
 2024-09-20|        10846|   5|
 2024-09-20|        10907|  -1|
 2024-09-20|        10919|   4|
 2024-09-20|        10922|   4|
 2024-09-20|        10943|   4|
 2024-09-20|        10987|   5|
 2024-09-20|        11014|  -1|
 2024-09-20|        11052|   5|
 2024-09-20|        11289|   5|
 2024-09-20|        11361|  -1|
 2024-09-20|        11777|   3|
 2024-09-20|        11982|   5|
 2024-09-20|        12021|  -1|
 2024-09-20|        12035|  -1|
 2024-09-20|        12051|   5|
 2024-09-20|        12090|   4|
 2024-09-20|        12131|  -1|
 2024-09-20|        12351|   2|
 2024-09-20|        12376|  -1|
 2024-09-20|        12413|  -1|
 2024-09-20|        12418|  -1|
 2024-09-20|        12448|  -1|
```

### 20. Получаем количество уникальных значений lesson_date и mark

```sql
SELECT count(DISTINCT lesson_date) FROM learn_db.mart_student_lesson_idx;
SELECT count(DISTINCT mark) FROM learn_db.mart_student_lesson_idx;
```

Результат
```text
countDistinct(lesson_date)|
--------------------------+
                       366|
                       
countDistinct(mark)|
-------------------+
                  5|                       
```

### 21. Пересоздаем таблицу с первым полем в первичном индексе, в котором меньше всего уникальных значений

```sql
DROP TABLE IF EXISTS learn_db.mart_student_lesson_idx;
CREATE TABLE learn_db.mart_student_lesson_idx
(
	`student_profile_id` Int32, -- Идентификатор профиля обучающегося
	`person_id` String, -- GUID обучающегося
	`person_id_int` Int32 CODEC(Delta, ZSTD),
	`educational_organization_id` Int16, -- Идентификатор образовательной организации
	`parallel_id` Int16,
	`class_id` Int16, -- Идентификатор класса
	`lesson_date` Date32, -- Дата урока
	`lesson_month_digits` String,
	`lesson_month_text` String,
	`lesson_year` UInt16,
	`load_date` Date, -- Дата загрузки данных
	`t` Int16 CODEC(Delta, ZSTD),
	`teacher_id` Int32 CODEC(Delta, ZSTD), -- Идентификатор учителя
	`subject_id` Int16 CODEC(Delta, ZSTD), -- Идентификатор предмета
	`subject_name` String,
	`mark` Int8, -- Оценка
	PRIMARY KEY (mark, lesson_date, person_id_int)
) ENGINE = MergeTree()
AS
SELECT
	student_profile_id,
	person_id,
	person_id_int,
	educational_organization_id,
	parallel_id,
	class_id,
	lesson_date,
	lesson_month_digits,
	lesson_month_text,
	lesson_year,
	load_date,
	t,
	teacher_id,
	subject_id,
	subject_name,
	mark
FROM
	learn_db.mart_student_lesson;
```

### 22. Смотрим план выполнения запроса со статистикой по применению индекса

```sql
EXPLAIN indexes = 1
SELECT 
	avg(mark) as avg_m,
	teacher_id
FROM 
	learn_db.mart_student_lesson_idx
WHERE 
	lesson_date = subtractDays(today(), 10)
GROUP BY
	teacher_id
ORDER BY avg_m desc
LIMIT 10;
```

Результат
```text
explain                                                           |
------------------------------------------------------------------+
Expression (Project names)                                        |
  Limit (preliminary LIMIT (without OFFSET))                      |
    Sorting (Sorting for ORDER BY)                                |
      Expression ((Before ORDER BY + Projection))                 |
        Aggregating                                               |
          Expression (Before GROUP BY)                            |
            Expression                                            |
              ReadFromMergeTree (learn_db.mart_student_lesson_idx)|
              Indexes:                                            |
                PrimaryKey                                        |
                  Keys:                                           |
                    lesson_date                                   |
                  Condition: (lesson_date in [20341, 20341])      |
                  Parts: 5/5                                      |
                  Granules: 43/1223                               |
```